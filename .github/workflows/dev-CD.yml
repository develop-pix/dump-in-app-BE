name: CD

on:
  pull_request:
    branches: [ "develop", "main" ]

jobs:
  # django-test:
  #   runs-on: ubuntu-latest
  #   strategy:
  #     max-parallel: 4
  #     matrix:
  #       python-version: [3.11.5]

  #   steps:

  #   - name: Set up Python ${{ matrix.python-version }}
  #     uses: actions/setup-python@v3
  #     with:
  #       python-version: ${{ matrix.python-version }}

  #   - name: Install Poetry
  #     run: |
  #       curl -sSL https://install.python-poetry.org | python -

  #   - name: Install Dependencies
  #     run: |
  #       poetry install

  #   - name: Run isort
  #     run: poetry run isort .

  #   - name: Run black
  #     run: poetry run black .

  #   - name: Run flake8
  #     run: poetry run flake8

  #   - name: Type check
  #     run: |
  #       poetry run mypy --config mypy.ini dump_in/

  #   - name: Run tests
  #     run: |
  #       poetry run pytest --cov=dump_in tests/ &&
  #       poetry run pytest --cov=dump_in --cov-fail-under=80 tests/

  docker-image-build-and-deploy:
    # needs: django-test
    runs-on: ubuntu-latest
    steps:

    - name: github checkout
      uses: actions/checkout@v2

    - name: aws configure
      uses: aws-actions/configure-aws-credentials@v1
      with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

    - name: Login to ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: build docker file and setting deploy files
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: dump-in-dev
        DJANGO_DEV_ENV: ${{ secrets.DJANGO_DEV_ENV }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo $DJANGO_DEV_ENV > .env
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f ./docker/dev.Dockerfile .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        sed -i "s%<IMAGE>%$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG%g" ./docker-compose.yml
        sed -i "s%<DJANGO_SETTINGS_MODULE>%config.django.dev%g" ./docker-compose.yml
        touch deploy.sh
        echo "#!/bin/bash" >> deploy.sh
        echo "aws ecr get-login-password --region ap-northeast-2 | sudo docker login --username AWS --password-stdin $ECR_REGISTRY" >> deploy.sh
        echo "pwd" >> deploy.sh
        echo "sudo docker compose up -d" >> deploy.sh

    - name: upload to s3
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        zip -r deploy-$IMAGE_TAG.zip appspec.yml deploy.sh docker-compose.yml ./nginx
        aws s3 cp --region ap-northeast-2 --acl private ./deploy-$IMAGE_TAG.zip s3://dump-in-deploy/dev/

    - name: start deploy
      env:
        IMAGE_TAG: ${{ github.sha }}
      run: |
        aws deploy create-deployment --application-name dump-in-dev-deploy \
        --deployment-config-name CodeDeployDefault.OneAtATime \
        --deployment-group-name deploy-group \
        --s3-location bucket=dump-in-deploy,bundleType=zip,key=dev/deploy-$IMAGE_TAG.zip
